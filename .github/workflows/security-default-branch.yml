on:
  workflow_call:
    inputs: { }
    secrets:
      DEPENDENCY_TRACK_AUTOMATION_API_KEY:
        required: true
  #     GH_TOKEN:
  #       required: true
  push:
    branches:
      - main

name: Security

permissions:
  contents: read

jobs:
  sbom-trivy:
    runs-on: ubuntu-latest
    container:
      image: aquasec/trivy:0.67.2
    steps:
      - run: trivy --version
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: false
      - run: trivy fs --format cyclonedx --output /tmp/trivy-cyclonedx.json .
      - run: apk --no-cache add curl
      - run: |
          curl -X "POST" "https://dependency-track-sbom.corp.zoo.dev/api/v1/bom" \
               -H 'Content-Type: multipart/form-data' \
                -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_AUTOMATION_API_KEY }}" \
               -F "autoCreate=true" \
               -F "projectName=$PROJECT_NAME" \
               -F "projectVersion=$PROJECT_VERSION" \
               -F "isLatest=$IS_LATEST" \
               -F "bom=@/tmp/trivy-cyclonedx.json"
        env:
          PROJECT_NAME: ${{ github.repository }}
          PROJECT_VERSION: ${{ github.ref_name }}

  semgrep:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: false
      - uses: KittyCAD/gha-workflows/.github/actions/semgrep-action@security
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}

  zizmor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: false
      - uses: KittyCAD/gha-workflows/.github/actions/zizmor-action@security
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}

  scorecard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: false
      - uses: KittyCAD/gha-workflows/.github/actions/scorecard-action@security
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}
